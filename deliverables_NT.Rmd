---
title: "Extended analyses for Northwest Territories caribou range planning"
author: "Alex M. Chubaty & Tati Micheletti"
date: "2022-07-29"
output:
  pdf_document: default
editor_options:
  chunk_output_type: console
  markdown:
    wrap: sentence
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  eval = TRUE,
  message = FALSE,
  warning = FALSE,
  results = "hold"
)

if (file.exists(".Renviron")) readRenviron(".Renviron")

source("01-packages.R")

if (!"Require" %in% rownames(installed.packages())) {
  remotes::install_github("PredictiveEcology/Require@development")
} else if (packageVersion("Require") < "0.1.0.9000") {
  remotes::install_github("PredictiveEcology/Require@development")
}
library("Require")

source("02-init.R")
source("03-paths.R")

do.call(setPaths, summaryPaths)

Require(c("fs", "knitr", "qs"))

nwt_data_dirs <- list(
  landscape_raw = Paths$outputPath, #TODO Not sure this needs to list all individual folders with results? ~TM
  landscape = Paths$outputPath, # TODO: Alex to update this once all landscape summaries have been made
  caribouRSF_raw = file.path(Paths$outputPath, "caribouRSF_predictions"),  ## raw results (.tif)
  caribouPopGrowth_raw = file.path(dirname(Paths$outputPath), "posthoc"),  ## raw results (.tif)
  caribou = file.path(Paths$outputPath, "caribouPlots")
)
stopifnot(dir.exists(unlist(nwt_data_dirs))) # Use base R instead of xfun package

```

## Overview

This document summarizes the data product deliverables quoted for ENR-GNWT as described in the 
tasks below:  

1. Landscape simulations (5 replicates for each of the 3 CMIP6 climate scenarios) for the period between 2011 and 2100, followed by summarizing wildfire results using 3 different sets of polygons contained within the NT1 caribou management area.

2. Simulated caribou population growth using landscape simulations described in 1, followed by summarizing results per polygon (table of raw results).

3. Simulated caribou resource selection using landscape simulations described in 1, followed by summarizing results per polygon (table of raw results, maps of change from 2021 to 2100, and
average and deviance across replicates and climate scenarios as uncertainty).

All data products and modules have been developed using the PERFICT approach as outlined in McIntire et al. [-@mcintire_perfict_2022], which enables them to be part of update cycles as needed going forward.

### Changes from the expected deliverables  

To reduce uncertainty, we have increased the number of replicates from 5 to 10, and the climate scenarios from 3 to 4 (two GMC's -- CanESM5 and CNRM-ESM2-1 -- and 2 SSPs -- 370 and 585), which represent the most likely climate scenarios to be realized. Moreover, to ensure compatibility with the time steps proposed for caribou (10 year period), the last simulation performed for both RSF and population growth was 2091, not 2100 (as we start the simulations in 2011).

### Opening files  

Please note that `tif` files can be opened using the `raster` package in `R` or 
imported to a GIS software (i.e., ArcGIS, QGIS). On the other hand, `qs` files need to 
be opened in `R` using the `qs` library (`qs::qread()`), but can be saved in `R` as a `.csv` 
file and opened in `Excel`. We caution, however, that most of these files are very large due 
to the extent of the study area and one might face software limitations when converting 
these objects to an Excel compatible format. 

## Landscape simulations

Our simulation experiments were designed to contrast climate-sensitive and non-climate sensitive models for tree growth and mortality, in addition to wildfire from 2011-2100 [Table 2, @micheletti2021]. Simulations used a climate-sensitive vegetation model (LandR.CS), together with a climate-sensitive wildfire model (fireSense).

Each simulation run produced the following files, where `YYYY` is the year in question:

- yearly aboveground net primary productivity (ANPP) maps:  
    --> `ANPPMap_YYYY_yearYYYY.tif`
- yearly wildfire burn maps:
    --> `burnMap_YYYY_yearYYYY.tif`
- wildfire burn summary for year 2100, containing information on all simulated fires 
with total area burned for all years:  
    --> `burnSummary_year2100.qs`
- yearly wildfire of simulated burned pixels for all years:  
    --> `rstCurrentBurn_YYYY_yearYYYY.tif`
- yearly vegetation (tree only) cohort data objects,  
    --> `cohortData_YYYY_yearYYYY.qs`
from which cohort age, aboveground biomass, and species composition can be extracted using the accompanying map:  
    --> `pixelGroupMap_YYYY_yearYYYY.tif` (matched by pixelGroup)
- wildfire ignition, escape, and spread model predictions for all years:  
    --> `fireSense_IgnitionPredicted_YYYY_yearYYYY.tif`  
    --> `fireSense_EscapePredicted_YYYY_yearYYYY.tif`  
    --> `fireSense_SpreadPredicted_YYYY_yearYYYY.tif`  
- yearly vegetation (tree) mortality maps:  
    --> `mortalityMap_YYYY_yearYYYY.tif`
- yearly simulated vegetation biomass maps:  
    --> `simulatedBiomassMap_YYYY_yearYYYY.tif`

#### Raw outputs:

```{r NWT-file-info-landscape-raw}
allFilesLandscapeRaw_NWT <- subset(fs::dir_info(nwt_data_dirs$landscape_raw, recurse = TRUE), type == "file")
allFilesLandscapeRaw_NWT$ext <- tools::file_ext(allFilesLandscapeRaw_NWT$path)
```

Total archive size: `r paste0(sum(allFilesLandscapeRaw_NWT$size), "B")`.

#### Summarized layers:

```{r NWT-file-info-landscape}
allFilesLandscape_NWT <- subset(fs::dir_info(nwt_data_dirs$landscape, recurse = TRUE), type == "file")
allFilesLandscape_NWT$ext <- tools::file_ext(allFilesLandscape_NWT$path)
```

Total archive size: `r paste0(sum(allFilesLandscape_NWT$size), "B")`.

All landscape simulation summary products can be find at <https://drive.google.com/drive/u/0/folders/1t6032ggUC__jzaJs5H39LW6iFfrqlK_T>

## Boreal Caribou simulations

For both models below (RSF and Population Growth), we simulated changes across 90 years 
of climate-driven landscape change [as described in @stewart; available [here](https://drive.google.com/file/d/1NHzLDCbfEr2x5J3eD59r7uojrE-VN1y9/)].

### Boreal Population Resource Selection (RSF)

We forecast suitable habitat for Boreal woodland caribou (_Rangifer tarandus caribou_) across the union of the three sets of polygons containing Northwest Territories' caribou ranges. We generated the following products, where `SHP` stands for the shapefile used for the maps (RangePlanRegions, GNWT_NT1_range, Revised_Study_Areas), `YYYY` stands for the year (2011, 2031, 2051, 2071 or 2091), `RR` stands for the replicate number (01 to 10), `CLIMMOD` stands for the climate model (CanESM5 or CNRM-ESM2-1) and `XXX` stands for the SSP (370 or 585) : 
 
- bi-decadal relative selection (RSF) forecast for each climate model and replicate:  
      --> `NT1_BCR6_CLIMMOD_SSPXXX_runRR_relativeSelectioncaribouRSF_NT_YearYYYY.tif`
- bi-decadal relative selection (RSF) forecast uncertainty (in the form of standard error) for each climate model and replicate:  
      --> `NT1_BCR6_CLIMMOD_SSPXXX_runRR_relativeSelectionUncertaincaribouRSF_NT_YearYYYY.tif`
- For each shapefile:  
  - map of the average difference between first and last year across:  
     - all climate models and SSP:  
       --> `averageDifference_SHP_allScenarios.png`  
     - each climate models and SSP:  
       --> `averageDifference_SHP_NT1_BCR6_CLIMMOD_SSPXXX.png`  
  - map of the SD difference first and last year across:  
     - all climate models and SSP:  
       --> `sdDifference_SHP_allScenarios.png`  
     - each climate models and SSP:  
       --> `sdDifference_SHP_NT1_BCR6_CLIMMOD_SSPXXX.png`  
  - Table of mean, standard deviation (SD) and confidence interval (CI) of binned RSF values for each polygon within the shapefile, climate model and replicate within the shapefile:
      --> `meanRSFperPolygon_SHP.qs`
  - Summarized table with mean, standard deviation (SD) and confidence interval (CI) of binned RSF values for each polygon within the shapefile, both for all and across climate model, across replicates:  
      --> `meanRSFperPolySummary_SHP.qs`

### Boreal Population Growth

We also simulated demographic parameters for all polygons within all three shapefiles. We generated the following products, where `SHP` stands for the shapefile used for the maps (RangePlanRegions, GNWT_NT1_range, Revised_Study_Areas), `YYYY` stands for the year (2011, 2031, 2051, 2071 or 2091), `RR` stands for the replicate number (01 to 10), `CLIMMOD` stands for the climate model (CanESM5 or CNRM-ESM2-1) and `XXX` stands for the SSP (370 or 585) : 

- layers used for population growth calculation per climate model and replicate:  
    --> `caribouLayers_yearYYYY_NT1_BCR6_CLIMMOD_SSPXXX_runRR.tif`
- disturbance summary at year 2091 (which contains all disturbances for all other years), per climate model and replicate:  
    --> `disturbances_Year2091_NT1_BCR6_CLIMMOD_SSPXXX_runRR_year2091.rds`
- predicted caribou values (lambda, recruitment and adult female mortality) at year 2091 (which contains values for all other years), per climate model and replicate:  
    --> `predictedCaribou_Year2091_NT1_BCR6_CLIMMOD_SSPXXX_runRR_year2091.rds`
- caribou population demographics plots per polygon per shapefile, showing increasing levels of uncertainty (5 to 85 quantiles; colored bands) using climate models and replicates as uncertainty measures:  
    --> `caribou_SHP_allCM_Johnson_Johnson.png`
- caribou population demographics table (summary) per polygon per shapefile, replicate and climate model:  
    --> `populationGrowthTable.csv` 
- disturbance table (summary) per polygon per shapefile, replicate and climate model:  
    --> `disturbanceTable.csv`  

#### Raw outputs:

```{r NWT-file-info-boo-raw}
caribouRSF_raw <- subset(fs::dir_info(nwt_data_dirs$caribouRSF_raw, recurse = TRUE), type == "file")
caribouRSF_raw$ext <- tools::file_ext(caribouRSF_raw$path)
caribouPopGrowth_raw <- subset(fs::dir_info(nwt_data_dirs$caribouPopGrowth_raw, recurse = TRUE), type == "file")
caribouPopGrowth_raw$ext <- tools::file_ext(caribouPopGrowth_raw$path)
```

Total archive size: `r paste0(sum(caribouRSF_raw$size, caribouPopGrowth_raw$size), "B")`.

#### Summarized layers:

```{r NWT-file-info-caribou}
caribou <- subset(dir_info(nwt_data_dirs$caribou, recurse = TRUE), type == "file")
caribou$ext <- tools::file_ext(caribou$path)
```

Total archive size: `r paste0(sum(caribou$size), "B")`.

All caribou summary products can be find at <https://drive.google.com/drive/u/0/folders/1IpC_u5c7Mluvqdxzk3pue5NFaBHyY6A6>

## Code availability  

All code used for the current project is publicly available at: <https://github.com/FOR-CAST/NT_caribou>. 
Some additional tools used and details of specific scripts are described below. 

### Additional tools for analyzing simulation results

#### `Biomass_summary` module

Summarizes the results of multiple LandR Biomass simulations, across multiple study areas, climate scenarios, and replicates.
Intended to be used for post-simulation processing of multiple LandR Biomass simulations, following a LandR-fS project structure and workflow described and templated in the `SpaDES.project` package.

Available from: <https://github.com/PredictiveEcology/Biomass_summary>

#### `caribouMetrics` package

Implements caribou resource selection functions, as well as caribou population and demographic models.
Incorporates code form Tati's [`caribouPopGrowthModel`](https://github.com/tati-micheletti/caribouPopGrowthModel) module and is used in this module to add uncertainty due to beta distribution used to fit the original models proposed by Johnson et al. [-@johnson2020].

Available from: <https://github.com/LandSciTech/caribouMetrics>

#### `fireSense_summary` module

Summarizes the results of multiple fireSense simulations, across multiple study areas, climate scenarios, and replicates.
Creates burn summary figures, historic burn summary plots, and cumulative simulated burn maps.

Available from: <https://github.com/PredictiveEcology/fireSense_summary>

#### `posthocLandR` module

Post-processing module for LandR Biomass simulations.
Prepares the biomass, leading species, average forest age objects for summary across simulations.

<!-- AC to review this address!! -->

Available from: <https://github.com/tati-micheletti/NWT/blob/development/modules/posthocLandR/posthocLandR.R>

#### `usefulFuns` package

Various utilities for producing summary plots and objects, including:

- assembling the layers for the caribou RSFs and plotting them;
- various plots for vegetation biomass;
- forest age plots;
- generating and plotting burn summary maps;
- helper functions for working with bird models;
- preparing climate layers.

Available from: <https://github.com/PredictiveEcology/usefulFuns> (forked form <https://github.com/tati-micheletti/usefulFuns>)

#### Summary `R` scripts

Various utilities to summarize the NWT simulation outputs and create plots for 
caribou components can be found in the `R` folder within the repository. 

- <https://github.com/FOR-CAST/NT_caribou/tree/main/R>

More specifically, the script used to create summaries and maps for both RSF and population growth can be found at:    

- <https://github.com/FOR-CAST/NT_caribou/tree/main/R/summarizeCaribou.R>

# References

<!-- autogenerated from references.bib -->
